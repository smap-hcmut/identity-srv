# SMAP Project API

Sequence diagrams for API flows in SMAP Project Service.

## Table of Contents
- [Project Management Flows](#project-management-flows)
  - [1. Create Project Flow](#1-create-project-flow)
  - [2. Get Project Detail Flow](#2-get-project-detail-flow)
  - [3. List Projects Flow](#3-list-projects-flow)
  - [4. Get Projects with Pagination Flow](#4-get-projects-with-pagination-flow)
  - [5. Update Project Flow](#5-update-project-flow)
  - [6. Delete Project Flow](#6-delete-project-flow)

---

## Project Management Flows

### 1. Create Project Flow

This flow handles project creation with brand and competitor tracking setup.

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: POST /project/projects<br/>{name, status, dates, brand, competitors}
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id, username, role}

    API->>API: Validate Request Body
    API->>ProjUC: Create(Scope, CreateInput)

    ProjUC->>ProjUC: Validate Status<br/>(draft|active|completed|archived|cancelled)
    ProjUC->>ProjUC: Validate Date Range<br/>(to_date > from_date)

    Note over ProjUC: Build Project Model<br/>ID = "" (DB will auto-generate)<br/>created_by = Scope.user_id

    ProjUC->>ProjRepo: Create(Project)
    ProjRepo->>DB: INSERT INTO projects<br/>(name, status, from_date, to_date,<br/>brand_name, brand_keywords,<br/>competitor_names, competitor_keywords_map,<br/>created_by, created_at, updated_at)
    DB->>DB: gen_random_uuid() generates ID
    DB-->>ProjRepo: Created Project (with ID)
    ProjRepo-->>ProjUC: Created Project

    ProjUC-->>API: ProjectOutput{Project}
    API-->>User: 201 Created<br/>{project}
```

**Key Points:**
- JWT token required (user_id extracted for created_by)
- ID auto-generated by database (`gen_random_uuid()`)
- Date validation: `to_date` must be after `from_date`
- Status must be one of: draft, active, completed, archived, cancelled
- Competitor keywords stored as JSONB map

---

### 2. Get Project Detail Flow

This flow retrieves a single project by ID with ownership verification.

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: GET /project/projects/{id}
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id}

    API->>ProjUC: Detail(Scope, project_id)

    ProjUC->>ProjRepo: Detail(project_id)
    ProjRepo->>DB: SELECT * FROM projects<br/>WHERE id = ? AND deleted_at IS NULL

    alt Project Found
        DB-->>ProjRepo: Project
        ProjRepo-->>ProjUC: Project

        ProjUC->>ProjUC: Check Ownership<br/>(project.created_by == Scope.user_id)

        alt User Owns Project
            ProjUC-->>API: ProjectOutput{Project}
            API-->>User: 200 OK<br/>{project}
        else User Does Not Own Project
            ProjUC-->>API: ErrUnauthorized
            API-->>User: 403 Forbidden<br/>{"error": "unauthorized"}
        end
    else Project Not Found
        DB-->>ProjRepo: No Rows
        ProjRepo-->>ProjUC: ErrNotFound
        ProjUC-->>API: ErrProjectNotFound
        API-->>User: 404 Not Found<br/>{"error": "project not found"}
    end
```

**Key Points:**
- Ownership verification (only creator can view)
- Soft delete check (deleted_at IS NULL)
- Returns 403 if user doesn't own the project

---

### 3. List Projects Flow

This flow lists all projects for the authenticated user (no pagination).

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: GET /project/projects<br/>?status=active&search_name=campaign
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id}

    API->>API: Parse Query Parameters<br/>(status[], search_name)
    API->>ProjUC: List(Scope, ListInput)

    Note over ProjUC: Auto-filter by user<br/>created_by = Scope.user_id

    ProjUC->>ProjRepo: List(ListOptions{<br/>  created_by: user_id,<br/>  statuses: ["active"],<br/>  search_name: "campaign"<br/>})

    ProjRepo->>DB: SELECT * FROM projects<br/>WHERE created_by = ?<br/>AND status IN (?)<br/>AND name ILIKE ?<br/>AND deleted_at IS NULL<br/>ORDER BY created_at DESC

    DB-->>ProjRepo: []Project
    ProjRepo-->>ProjUC: []Project
    ProjUC-->>API: []Project
    API-->>User: 200 OK<br/>[{project1}, {project2}, ...]
```

**Key Points:**
- Automatically filters by `created_by = user_id` (user isolation)
- Optional filters: status, search by name (case-insensitive)
- Returns all matching projects (no pagination limit)
- Ordered by `created_at DESC`

---

### 4. Get Projects with Pagination Flow

This flow retrieves projects with pagination support.

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: GET /project/projects/page<br/>?page=2&limit=10&status=active
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id}

    API->>API: Parse Pagination Params<br/>(page=2, limit=10)<br/>Calculate offset = (page-1) * limit = 10

    API->>ProjUC: Get(Scope, GetInput)
    ProjUC->>ProjRepo: Get(GetOptions{<br/>  created_by: user_id,<br/>  status: ["active"],<br/>  pagination: {offset:10, limit:10}<br/>})

    par Count Total
        ProjRepo->>DB: SELECT COUNT(*) FROM projects<br/>WHERE created_by = ?<br/>AND status = 'active'<br/>AND deleted_at IS NULL
        DB-->>ProjRepo: total = 25
    and Get Page Data
        ProjRepo->>DB: SELECT * FROM projects<br/>WHERE created_by = ?<br/>AND status = 'active'<br/>AND deleted_at IS NULL<br/>ORDER BY created_at DESC<br/>LIMIT 10 OFFSET 10
        DB-->>ProjRepo: []Project (10 items)
    end

    ProjRepo->>ProjRepo: Build Paginator<br/>{total:25, count:10, per_page:10, current_page:2}
    ProjRepo-->>ProjUC: ([]Project, Paginator)
    ProjUC-->>API: GetProjectOutput{Projects, Paginator}
    API-->>User: 200 OK<br/>{<br/>  "projects": [{...}],<br/>  "paginator": {total:25, count:10, ...}<br/>}
```

**Key Points:**
- Supports page and limit parameters
- Returns both data and pagination metadata
- Efficient: COUNT and SELECT run in parallel
- Default: page=1, limit=15 (configured in paginator)

---

### 5. Update Project Flow

This flow updates an existing project with ownership verification.

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: PUT /project/projects/{id}<br/>{status: "active", description: "Updated"}
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id}

    API->>API: Validate Request Body
    API->>ProjUC: Update(Scope, UpdateInput)

    ProjUC->>ProjRepo: Detail(project_id)
    ProjRepo->>DB: SELECT * FROM projects<br/>WHERE id = ? AND deleted_at IS NULL
    DB-->>ProjRepo: Project
    ProjRepo-->>ProjUC: Project

    ProjUC->>ProjUC: Check Ownership<br/>(project.created_by == Scope.user_id)

    alt User Owns Project
        ProjUC->>ProjUC: Apply Updates<br/>(only non-null fields)<br/>Validate status & date range
        ProjUC->>ProjUC: Set updated_at = NOW()

        ProjUC->>ProjRepo: Update(Project)
        ProjRepo->>DB: UPDATE projects<br/>SET status=?, description=?, updated_at=?<br/>WHERE id = ?
        DB-->>ProjRepo: Updated Project
        ProjRepo-->>ProjUC: Updated Project

        ProjUC-->>API: ProjectOutput{Project}
        API-->>User: 200 OK<br/>{updated_project}
    else User Does Not Own Project
        ProjUC-->>API: ErrUnauthorized
        API-->>User: 403 Forbidden<br/>{"error": "unauthorized"}
    end
```

**Key Points:**
- Partial updates (only provided fields are updated)
- Ownership check before allowing update
- Date range validation if dates are updated
- Status validation if status is updated
- `updated_at` automatically set

---

### 6. Delete Project Flow

This flow soft-deletes a project (sets deleted_at timestamp).

```mermaid
sequenceDiagram
    actor User
    participant API as API Handler
    participant MW as JWT Middleware
    participant ProjUC as Project UseCase
    participant ProjRepo as Project Repository
    participant DB as PostgreSQL

    User->>API: DELETE /project/projects/{id}
    API->>MW: Extract JWT Token
    MW->>MW: Validate Token & Extract user_id
    MW-->>API: Scope{user_id}

    API->>ProjUC: Delete(Scope, project_id)

    ProjUC->>ProjRepo: Detail(project_id)
    ProjRepo->>DB: SELECT * FROM projects<br/>WHERE id = ? AND deleted_at IS NULL
    DB-->>ProjRepo: Project
    ProjRepo-->>ProjUC: Project

    ProjUC->>ProjUC: Check Ownership<br/>(project.created_by == Scope.user_id)

    alt User Owns Project
        ProjUC->>ProjRepo: Delete(project_id)
        ProjRepo->>DB: UPDATE projects<br/>SET deleted_at = NOW()<br/>WHERE id = ?
        DB-->>ProjRepo: Success
        ProjRepo-->>ProjUC: Success

        ProjUC-->>API: nil (no error)
        API-->>User: 204 No Content
    else User Does Not Own Project
        ProjUC-->>API: ErrUnauthorized
        API-->>User: 403 Forbidden<br/>{"error": "unauthorized"}
    end
```

**Key Points:**
- Soft delete (sets `deleted_at` timestamp)
- Data preserved for audit/recovery
- Ownership check before allowing delete
- Returns 204 No Content on success
- Deleted projects excluded from all queries

---

## Common Error Responses

### Authentication Errors
```json
// 401 Unauthorized - Missing or invalid JWT
{
  "error_code": 401,
  "message": "unauthorized"
}
```

### Authorization Errors
```json
// 403 Forbidden - User doesn't own the project
{
  "error_code": 403,
  "message": "unauthorized to access this project"
}
```

### Validation Errors
```json
// 400 Bad Request - Invalid input
{
  "error_code": 400,
  "message": "invalid date range: to_date must be after from_date"
}

{
  "error_code": 400,
  "message": "invalid project status"
}
```

### Not Found Errors
```json
// 404 Not Found
{
  "error_code": 404,
  "message": "project not found"
}
```

---

## Request/Response Examples

### Create Project Request
```json
POST /project/projects
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "name": "Q1 2025 Campaign",
  "description": "First quarter brand monitoring",
  "status": "draft",
  "from_date": "2025-01-01T00:00:00Z",
  "to_date": "2025-03-31T23:59:59Z",
  "brand_name": "MyBrand",
  "brand_keywords": ["mybrand", "my brand", "brand"],
  "competitor_names": ["Competitor A", "Competitor B"],
  "competitor_keywords_map": {
    "Competitor A": ["competitor-a", "comp-a"],
    "Competitor B": ["competitor-b", "comp-b"]
  }
}
```

### Success Response
```json
HTTP/1.1 201 Created
Content-Type: application/json

{
  "error_code": 0,
  "message": "Success",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Q1 2025 Campaign",
    "description": "First quarter brand monitoring",
    "status": "draft",
    "from_date": "2025-01-01T00:00:00Z",
    "to_date": "2025-03-31T23:59:59Z",
    "brand_name": "MyBrand",
    "brand_keywords": ["mybrand", "my brand", "brand"],
    "competitor_names": ["Competitor A", "Competitor B"],
    "competitor_keywords_map": {
      "Competitor A": ["competitor-a", "comp-a"],
      "Competitor B": ["competitor-b", "comp-b"]
    },
    "created_by": "user-uuid-from-jwt",
    "created_at": "2025-11-21T14:30:00Z",
    "updated_at": "2025-11-21T14:30:00Z"
  }
}
```

---

**Last Updated**: November 21, 2025
**Document Version**: 1.0.0
**Maintained By**: SMAP Development Team
